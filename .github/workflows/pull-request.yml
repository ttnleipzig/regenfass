name: Pull request

on:
  push:
    branches:
      - feature/*
      - experimental/*

permissions:
  contents: write
  packages: write
  actions: write

jobs:

  # Job to create a new pull request for the current branch if it does not exist yet
  create_pull_request:
    name: Create Pull Request
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/feature/*'
    steps:
    - uses: actions/checkout@v4
    - uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        title: "${{ github.ref }} - Create pull request"
        body: "This pull request was automatically created by the [create-pull-request](${{ github.actions_url }}/actions/workflows/create-pull-request.yml) GitHub Action."
        branch: "feature/${{ github.ref }}"
        branch-suffix: "feature/${{ github.ref }}"
        labels: "auto-generated"
        assignees: ${{ github.actor }}
        reviewers: ${{ github.actor }}
        team-reviewers: ${{ github.actor }}
        milestone: "none"
        draft: false
        delete-branch: true

  build:
    name: Build Environments
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        environment: ["heltec_wifi_lora_32_V3_HCSR04"]
    steps:
      - uses: actions/checkout@v3
      - uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            ~/.platformio/.cache
          key: ${{ runner.os }}-pio
      - uses: actions/setup-python@v4
        with:
          python-version: "3.9"
      - name: Install PlatformIO Core
        run: pip install --upgrade platformio
      - name: Build firmware
        run: pio run -e ${{ matrix.environment }}


#      - name: ðŸ’¾ Upload artifacts
#        uses: gavv/pull-request-artifacts@v2
#        with:
#          commit: ${{ github.event.pull_request.head.sha }}
#          repo-token: ${{ secrets.GITHUB_TOKEN }}
#          artifacts: |
#            app/build/outputs/apk/debug/app-debug.apk
#            app/build/outputs/bundle/debug/app-debug.aab
#
#      - uses: actions/upload-artifact@v2
#        with:
#          name: firmware-${{ matrix.environment }}
#          path: |
#            .pio/build/${{ matrix.environment }}/*.bin
#      - uses: actions/upload-artifact@v2
#        if: startsWith(github.ref, 'refs/tags/')
#        with:
#          name: firmware-release
#          path: .pio/build/${{ matrix.environment }}/*.bin
#
